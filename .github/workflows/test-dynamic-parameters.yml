name: "Test Dynamic Span Parameters"

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  # Test the new emit-params action (artifact-based approach)
  test-emit-params:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          echo "Setting up test environment"

      - name: Emit setup parameters
        uses: ./emit-params
        with:
          step: '{"setup.duration": "1s", "setup.status": "complete"}'
          job: '{"job.test_type": "integration"}'
          workflow: '{"workflow.test_run": "true"}'

      - name: Build with metrics
        id: build
        run: |
          echo "Building application..."
          sleep 1
          echo "Build complete!"

      - name: Emit build parameters
        uses: ./emit-params
        with:
          step: '{"build.duration": "1s", "build.status": "success", "build.size": "1.2MB"}'
          job: '{"job.artifacts_count": "3"}'

      - name: Run tests with metrics
        id: tests
        run: |
          echo "Running tests..."
          sleep 1
          echo "Tests complete!"

      - name: Emit test parameters
        uses: ./emit-params
        with:
          params: |
            test.total=150
            test.passed=148
            test.failed=2
          scope: step

      - name: Emit job coverage
        uses: ./emit-params
        with:
          job: '{"job.coverage": "92.5%"}'
          workflow: '{"workflow.quality_gate": "passed"}'

      - name: Deploy (simulated)
        run: |
          echo "Deploying version 1.2.3-test"

      - name: Emit deployment parameters
        uses: ./emit-params
        with:
          step: '{"deploy.time": "5s"}'
          workflow: '{"deployment.version": "1.2.3-test", "deployment.environment": "test"}'

  export-emit-params-trace:
    needs: [test-emit-params]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: npm

      - name: Install Dependencies
        run: npm ci

      - name: Build action
        run: npm run build

      - name: Export trace with artifact parameters
        id: export
        uses: ./
        with:
          otlpEndpoint: "console"
          otlpHeaders: "test=true"
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          spanParamsArtifact: "otel-span-parameters"
          parseLogParameters: "false"
        env:
          OTEL_CONSOLE_ONLY: "true"

      - name: Validate trace export succeeded
        uses: actions/github-script@v7
        with:
          script: |
            const traceId = '${{ steps.export.outputs.traceId }}';
            console.log('Trace ID:', traceId);

            if (!traceId || traceId.length === 0) {
              core.setFailed('Trace ID was not generated');
              return;
            }

            console.log('✅ Trace export with emit-params completed successfully');
            console.log('');
            console.log('Expected dynamic parameters from emit-params action:');
            console.log('  Step-level parameters:');
            console.log('    - setup.duration, setup.status');
            console.log('    - build.duration, build.status, build.size');
            console.log('    - test.total, test.passed, test.failed');
            console.log('    - deploy.time');
            console.log('  Job-level parameters:');
            console.log('    - job.test_type, job.artifacts_count, job.coverage');
            console.log('  Workflow-level parameters:');
            console.log('    - workflow.test_run, workflow.quality_gate');
            console.log('    - deployment.version, deployment.environment');

  # Test log-based approach still works (legacy)
  test-log-parsing:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          echo "Setting up test environment"
          echo "<step-parameter key=\"setup.duration\" value=\"1s\"/>"
          echo "<job-parameter key=\"job.test_type\" value=\"integration\"/>"
          echo "<workflow-parameter key=\"workflow.test_run\" value=\"true\"/>"

      - name: Build with metrics
        run: |
          echo "Building application..."
          sleep 1
          echo "<span-parameter key=\"build.duration\" value=\"1s\"/>"
          echo "<span-parameter key=\"build.status\" value=\"success\"/>"
          echo "<span-parameter key=\"build.size\" value=\"1.2MB\"/>"
          echo "<job-parameter key=\"job.artifacts_count\" value=\"3\"/>"

      - name: Run tests with metrics
        run: |
          echo "Running tests..."
          echo "<span-parameter key=\"test.total\" value=\"150\"/>"
          echo "<span-parameter key=\"test.passed\" value=\"148\"/>"
          echo "<span-parameter key=\"test.failed\" value=\"2\"/>"
          echo "<job-parameter key=\"job.coverage\" value=\"92.5%\"/>"
          echo "<workflow-parameter key=\"workflow.quality_gate\" value=\"passed\"/>"

      - name: Deploy (workflow-level parameter)
        run: |
          echo "Deploying version 1.2.3-test"
          echo "<workflow-parameter key=\"deployment.version\" value=\"1.2.3-test\"/>"
          echo "<workflow-parameter key=\"deployment.environment\" value=\"test\"/>"
          echo "<span-parameter key=\"deploy.time\" value=\"5s\"/>"

  export-log-parsing-trace:
    needs: [test-log-parsing]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: npm

      - name: Install Dependencies
        run: npm ci

      - name: Build action
        run: npm run build

      - name: Export trace with log parsing enabled
        id: export
        uses: ./
        with:
          otlpEndpoint: "console"
          otlpHeaders: "test=true"
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          parseLogParameters: "true"
          spanParamsArtifact: ""
        env:
          OTEL_CONSOLE_ONLY: "true"

      - name: Validate trace export succeeded
        uses: actions/github-script@v7
        with:
          script: |
            const traceId = '${{ steps.export.outputs.traceId }}';
            console.log('Trace ID:', traceId);

            if (!traceId || traceId.length === 0) {
              core.setFailed('Trace ID was not generated');
              return;
            }

            console.log('✅ Trace export with log parsing completed successfully');
            console.log('Note: Log parsing may have limited results due to GitHub API timing.');

  test-disabled-parsing:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Step with parameters (should be ignored)
        run: |
          echo "This parameter should be ignored"
          echo "<span-parameter key=\"ignored.param\" value=\"should_not_appear\"/>"

  export-disabled:
    needs: [test-disabled-parsing]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: npm

      - name: Install Dependencies
        run: npm ci

      - name: Build action
        run: npm run build

      - name: Export trace with all parameters disabled
        id: export
        uses: ./
        with:
          otlpEndpoint: "console"
          otlpHeaders: "test=true"
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          parseLogParameters: "false"
          spanParamsArtifact: ""
        env:
          OTEL_CONSOLE_ONLY: "true"

      - name: Validate disabled parsing
        run: |
          echo "Trace ID: ${{ steps.export.outputs.traceId }}"
          echo "✅ All parameter parsing disabled test completed"
          echo "Parameters should NOT be parsed when both features are disabled"
