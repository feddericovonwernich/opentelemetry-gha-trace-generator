name: "Test Dynamic Span Parameters"

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  # Test the new emit-params action (artifact-based approach)
  test-emit-params:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          echo "Setting up test environment"

      - name: Emit setup parameters
        uses: ./emit-params
        with:
          step: '{"setup.duration": "1s", "setup.status": "complete"}'
          job: '{"job.test_type": "integration"}'
          workflow: '{"workflow.test_run": "true"}'

      - name: Build with metrics
        id: build
        run: |
          echo "Building application..."
          sleep 1
          echo "Build complete!"

      - name: Emit build parameters
        uses: ./emit-params
        with:
          step: '{"build.duration": "1s", "build.status": "success", "build.size": "1.2MB"}'
          job: '{"job.artifacts_count": "3"}'

      - name: Run tests with metrics
        id: tests
        run: |
          echo "Running tests..."
          sleep 1
          echo "Tests complete!"

      - name: Emit test parameters
        uses: ./emit-params
        with:
          params: |
            test.total=150
            test.passed=148
            test.failed=2
          scope: step

      - name: Emit job coverage
        uses: ./emit-params
        with:
          job: '{"job.coverage": "92.5%"}'
          workflow: '{"workflow.quality_gate": "passed"}'

      - name: Deploy (simulated)
        run: |
          echo "Deploying version 1.2.3-test"

      - name: Emit deployment parameters
        uses: ./emit-params
        with:
          step: '{"deploy.time": "5s"}'
          workflow: '{"deployment.version": "1.2.3-test", "deployment.environment": "test"}'

  export-emit-params-trace:
    needs: [test-emit-params]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: npm

      - name: Install Dependencies
        run: npm ci

      - name: Build action
        run: npm run build

      - name: Download and validate artifact
        uses: actions/download-artifact@v4
        with:
          name: otel-span-parameters
          path: otel-span-params

      - name: Validate artifact contents
        run: |
          echo "Validating artifact was uploaded correctly..."

          if [ ! -f otel-span-params/params.json ]; then
            echo "❌ params.json not found in artifact"
            exit 1
          fi

          echo "✅ Artifact downloaded successfully"
          echo ""
          echo "Artifact contents:"
          cat otel-span-params/params.json | jq .

          # Validate structure
          WORKFLOW_PARAMS=$(cat otel-span-params/params.json | jq '.workflow')
          JOB_PARAMS=$(cat otel-span-params/params.json | jq '.job')
          STEP_PARAMS=$(cat otel-span-params/params.json | jq '.steps')

          if [ "$WORKFLOW_PARAMS" == "null" ] || [ "$JOB_PARAMS" == "null" ] || [ "$STEP_PARAMS" == "null" ]; then
            echo "❌ Invalid artifact structure"
            exit 1
          fi

          # Check for expected workflow parameters
          if ! echo "$WORKFLOW_PARAMS" | jq -e '.["workflow.test_run"]' > /dev/null; then
            echo "❌ Missing workflow.test_run parameter"
            exit 1
          fi

          # Check for expected job parameters
          if ! echo "$JOB_PARAMS" | jq -e '.["job.test_type"]' > /dev/null; then
            echo "❌ Missing job.test_type parameter"
            exit 1
          fi

          # Check that steps exist
          STEP_COUNT=$(echo "$STEP_PARAMS" | jq 'keys | length')
          if [ "$STEP_COUNT" -lt 4 ]; then
            echo "❌ Expected at least 4 step parameter entries, found $STEP_COUNT"
            exit 1
          fi

          echo ""
          echo "✅ Artifact validation passed:"
          echo "  - Workflow parameters: $(echo "$WORKFLOW_PARAMS" | jq 'keys | length') keys"
          echo "  - Job parameters: $(echo "$JOB_PARAMS" | jq 'keys | length') keys"
          echo "  - Step parameters: $STEP_COUNT step entries"

      - name: Export trace and capture output
        id: export
        run: |
          # Run the action and capture console output to a file
          node dist/index.js 2>&1 | tee trace-output.txt
        env:
          INPUT_OTLPENDPOINT: "console"
          INPUT_OTLPHEADERS: "test=true"
          INPUT_GITHUBTOKEN: ${{ secrets.GITHUB_TOKEN }}
          INPUT_SPANPARAMSARTIFACT: "otel-span-parameters"
          INPUT_PARSELOGPARAMETERS: "false"
          OTEL_CONSOLE_ONLY: "true"

      - name: Validate trace output contains parameters
        run: |
          echo "Validating that exported trace contains expected parameters..."
          echo ""

          if [ ! -f trace-output.txt ]; then
            echo "❌ Trace output file not found"
            exit 1
          fi

          # Check for workflow parameters
          MISSING=0
          echo "Checking workflow parameters:"
          for key in "workflow.test_run" "workflow.quality_gate" "deployment.version" "deployment.environment"; do
            if grep -q "\"$key\"" trace-output.txt; then
              # Also check the value is present
              if grep "\"$key\"" trace-output.txt | head -1; then
                echo "  ✓ Found: $key"
              fi
            else
              echo "  ✗ Missing: $key"
              MISSING=$((MISSING + 1))
            fi
          done

          # Check for job parameters
          echo ""
          echo "Checking job parameters:"
          for key in "job.test_type" "job.artifacts_count" "job.coverage"; do
            if grep -q "\"$key\"" trace-output.txt; then
              if grep "\"$key\"" trace-output.txt | head -1; then
                echo "  ✓ Found: $key"
              fi
            else
              echo "  ✗ Missing: $key"
              MISSING=$((MISSING + 1))
            fi
          done

          # Check for step parameters (sample)
          echo ""
          echo "Checking sample step parameters:"
          for key in "setup.duration" "build.status" "test.total" "deploy.time"; do
            if grep -q "\"$key\"" trace-output.txt; then
              if grep "\"$key\"" trace-output.txt | head -1; then
                echo "  ✓ Found: $key"
              fi
            else
              echo "  ✗ Missing: $key"
              MISSING=$((MISSING + 1))
            fi
          done

          echo ""
          if [ $MISSING -eq 0 ]; then
            echo "✅ All expected parameters found in trace output!"
            echo ""
            echo "Trace output preview (first 50 lines):"
            head -50 trace-output.txt
          else
            echo "❌ $MISSING parameters missing from trace output"
            echo ""
            echo "Trace output for debugging:"
            cat trace-output.txt
            exit 1
          fi

  # Test log-based approach still works (legacy)
  test-log-parsing:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          echo "Setting up test environment"
          echo "<step-parameter key=\"setup.duration\" value=\"1s\"/>"
          echo "<job-parameter key=\"job.test_type\" value=\"integration\"/>"
          echo "<workflow-parameter key=\"workflow.test_run\" value=\"true\"/>"

      - name: Build with metrics
        run: |
          echo "Building application..."
          sleep 1
          echo "<span-parameter key=\"build.duration\" value=\"1s\"/>"
          echo "<span-parameter key=\"build.status\" value=\"success\"/>"
          echo "<span-parameter key=\"build.size\" value=\"1.2MB\"/>"
          echo "<job-parameter key=\"job.artifacts_count\" value=\"3\"/>"

      - name: Run tests with metrics
        run: |
          echo "Running tests..."
          echo "<span-parameter key=\"test.total\" value=\"150\"/>"
          echo "<span-parameter key=\"test.passed\" value=\"148\"/>"
          echo "<span-parameter key=\"test.failed\" value=\"2\"/>"
          echo "<job-parameter key=\"job.coverage\" value=\"92.5%\"/>"
          echo "<workflow-parameter key=\"workflow.quality_gate\" value=\"passed\"/>"

      - name: Deploy (workflow-level parameter)
        run: |
          echo "Deploying version 1.2.3-test"
          echo "<workflow-parameter key=\"deployment.version\" value=\"1.2.3-test\"/>"
          echo "<workflow-parameter key=\"deployment.environment\" value=\"test\"/>"
          echo "<span-parameter key=\"deploy.time\" value=\"5s\"/>"

  export-log-parsing-trace:
    needs: [test-log-parsing]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: npm

      - name: Install Dependencies
        run: npm ci

      - name: Build action
        run: npm run build

      - name: Export trace with log parsing enabled
        id: export
        uses: ./
        with:
          otlpEndpoint: "console"
          otlpHeaders: "test=true"
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          parseLogParameters: "true"
          spanParamsArtifact: ""
        env:
          OTEL_CONSOLE_ONLY: "true"

      - name: Validate trace export succeeded
        run: |
          if [ -z "${{ steps.export.outputs.traceId }}" ]; then
            echo "❌ Trace ID was not generated"
            exit 1
          fi

          echo "✅ Trace export with log parsing completed successfully"
          echo "Trace ID: ${{ steps.export.outputs.traceId }}"
          echo ""
          echo "Note: Log parsing may have limited results due to GitHub API timing."
          echo "The job logs API returns 404 until logs are finalized after workflow completion."
          echo "This test verifies the mechanism works without errors, even if logs aren't available."

  test-disabled-parsing:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Step with parameters (should be ignored)
        run: |
          echo "This parameter should be ignored"
          echo "<span-parameter key=\"ignored.param\" value=\"should_not_appear\"/>"

  export-disabled:
    needs: [test-disabled-parsing]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: npm

      - name: Install Dependencies
        run: npm ci

      - name: Build action
        run: npm run build

      - name: Export trace with all parameters disabled
        id: export
        uses: ./
        with:
          otlpEndpoint: "console"
          otlpHeaders: "test=true"
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          parseLogParameters: "false"
          spanParamsArtifact: ""
        env:
          OTEL_CONSOLE_ONLY: "true"

      - name: Validate disabled parsing
        run: |
          echo "Trace ID: ${{ steps.export.outputs.traceId }}"
          echo "✅ All parameter parsing disabled test completed"
          echo "Parameters should NOT be parsed when both features are disabled"
